<script src="https://cdn.rawgit.com/calipho-sib/nextprot-js/v0.0.54/dist/nextprot.bundle.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<div id="container" style="height: 100%; width: 100%; margin: 0 auto"></div>

<script>
    
    
    var visualize = function (aas, data) {
        $('#container').highcharts({
            chart: {
                type: 'heatmap',
            },
            title: {
                text: 'Variants in neXtProt'
            },
            xAxis: {
                categories: aas,
            },
            yAxis: {
                categories: aas,
                title: null
            },
            colorAxis: {
                min: 0,
                minColor: '#FFFFFF',
                maxColor: Highcharts.getOptions().colors[0]
            },
            legend: {
                align: 'right',
                layout: 'vertical',
                margin: 0,
                verticalAlign: 'top',
                y: 25,
                symbolHeight: 320
            },
            tooltip: {
                formatter: function () {
                    return '<b>' + this.series.xAxis.categories[this.point.x] + '</b> -> <b>' + this.series.yAxis.categories[this.point.y] + '</b> ' + this.point.value + ' variants';
                }
            },
            series: [{
                name: 'Sales per employee',
                borderWidth: 1,
                data: data,
                dataLabels: {
                    enabled: true,
                    color: 'black',
                    style: {
                        textShadow: 'none'
                    }
                }
        }]

        });

    };
    
    var applicationInfo = "visualisation of variants in neXtProt";
    var clientInfo = "calipho group at SIB";
    var nx = new Nextprot.Client(applicationInfo, clientInfo);

    //Find number of variant for a substitution from A to R
    var sparqlQuery = `
        SELECT ?pred (count(distinct ?annotId) as ?cnt) WHERE {
         {
         # unique annotations (?annotId) for variant annotations
         values (?pred ) {
         (:variant )
         } .
         ?_ ?pred ?annot.
         ?annot :entryAnnotationId ?annotId .
          ?annot :original "AAO"^^xsd:string;:variation "AAV"^^xsd:string.
        }
        }
        `;

    var matrix = [];
    var promises = [];
    var aminoacids = ["A", "C", "D", "E", "F", "G", "H", "I", "K", "L", "M", "N", "P", "Q", "R", "S", "T", "V", "W", "Y"]


    //Comment this out if you want to compute it again
    var heatmap =[[0,0,1],[0,1,6],[0,2,23292],[0,3,15883],[0,4,30],[0,5,32892],[0,6,1],[0,7,22],[0,8,6],[0,9,31],[0,10,6],[0,11,9],[0,12,27193],[0,13,3],[0,14,6],[0,15,54307],[0,16,150257],[0,17,144932],[0,18,0],[0,19,5],[1,0,2],[1,1,0],[1,2,0],[1,3,0],[1,4,13089],[1,5,8059],[1,6,3],[1,7,3],[1,8,1],[1,9,10],[1,10,2],[1,11,3],[1,12,0],[1,13,2],[1,14,20539],[1,15,14994],[1,16,1],[1,17,2],[1,18,6763],[1,19,30484],[2,0,10913],[2,1,5],[2,2,0],[2,3,43716],[2,4,16],[2,5,45901],[2,6,29004],[2,7,5],[2,8,1],[2,9,2],[2,10,1],[2,11,98865],[2,12,4],[2,13,3],[2,14,6],[2,15,14],[2,16,1],[2,17,21133],[2,18,1],[2,19,33445],[3,0,18335],[3,1,0],[3,2,61898],[3,3,1],[3,4,0],[3,5,43809],[3,6,3],[3,7,19],[3,8,156751],[3,9,45],[3,10,11],[3,11,7],[3,12,3],[3,13,47298],[3,14,17],[3,15,10],[3,16,19],[3,17,16487],[3,18,0],[3,19,1],[4,0,2],[4,1,11593],[4,2,2],[4,3,0],[4,4,0],[4,5,3],[4,6,4],[4,7,8042],[4,8,1],[4,9,55150],[4,10,0],[4,11,5],[4,12,5],[4,13,0],[4,14,1],[4,15,18270],[4,16,3],[4,17,12403],[4,18,2],[4,19,7427],[5,0,32409],[5,1,20829],[5,2,54629],[5,3,60886],[5,4,50],[5,5,0],[5,6,2],[5,7,31],[5,8,673],[5,9,74],[5,10,16],[5,11,246],[5,12,4],[5,13,4],[5,14,98233],[5,15,70580],[5,16,13],[5,17,45778],[5,18,11331],[5,19,12],[6,0,3],[6,1,4],[6,2,8464],[6,3,1],[6,4,5],[6,5,1],[6,6,0],[6,7,1],[6,8,0],[6,9,9771],[6,10,0],[6,11,12220],[6,12,10905],[6,13,24249],[6,14,41795],[6,15,4],[6,16,6],[6,17,2],[6,18,0],[6,19,45784],[7,0,4],[7,1,3],[7,2,2],[7,3,0],[7,4,14795],[7,5,0],[7,6,4],[7,7,0],[7,8,2349],[7,9,17442],[7,10,34118],[7,11,11311],[7,12,3],[7,13,0],[7,14,1992],[7,15,8264],[7,16,56559],[7,17,84816],[7,18,0],[7,19,5],[8,0,10],[8,1,0],[8,2,3],[8,3,45143],[8,4,0],[8,5,3],[8,6,2],[8,7,4904],[8,8,1],[8,9,10],[8,10,6911],[8,11,51037],[8,12,0],[8,13,18204],[8,14,54131],[8,15,5],[8,16,22995],[8,17,3],[8,18,4],[8,19,1],[9,0,8],[9,1,5],[9,2,2],[9,3,2],[9,4,78479],[9,5,4],[9,6,7433],[9,7,25132],[9,8,6],[9,9,3],[9,10,21851],[9,11,4],[9,12,56079],[9,13,10773],[9,14,22397],[9,15,14466],[9,16,6],[9,17,63306],[9,18,4246],[9,19,21],[10,0,2],[10,1,0],[10,2,0],[10,3,0],[10,4,0],[10,5,0],[10,6,0],[10,7,46482],[10,8,6854],[10,9,17378],[10,10,0],[10,11,9],[10,12,1],[10,13,1],[10,14,6752],[10,15,5],[10,16,33916],[10,17,45883],[10,18,0],[10,19,0],[11,0,1],[11,1,0],[11,2,26641],[11,3,9],[11,4,4],[11,5,2],[11,6,13291],[11,7,10778],[11,8,32607],[11,9,5],[11,10,2],[11,11,0],[11,12,2],[11,13,0],[11,14,3],[11,15,70207],[11,16,12056],[11,17,1],[11,18,0],[11,19,8071],[12,0,39342],[12,1,7],[12,2,2],[12,3,1],[12,4,899],[12,5,1],[12,6,22588],[12,7,44],[12,8,30],[12,9,147943],[12,10,9],[12,11,22],[12,12,1],[12,13,15168],[12,14,37428],[12,15,133679],[12,16,42845],[12,17,16],[12,18,1],[12,19,18],[13,0,1],[13,1,0],[13,2,3],[13,3,28401],[13,4,1],[13,5,3],[13,6,46256],[13,7,1],[13,8,23483],[13,9,12342],[13,10,2],[13,11,0],[13,12,15486],[13,13,1],[13,14,49431],[13,15,1],[13,16,2],[13,17,2],[13,18,6],[13,19,2],[14,0,10],[14,1,107101],[14,2,4],[14,3,15],[14,4,6],[14,5,51165],[14,6,109393],[14,7,10843],[14,8,38078],[14,9,39595],[14,10,6561],[14,11,28],[14,12,23668],[14,13,133758],[14,14,0],[14,15,34438],[14,16,15657],[14,17,5],[14,18,88899],[14,19,6],[15,0,15641],[15,1,38025],[15,2,9],[15,3,4],[15,4,70731],[15,5,34772],[15,6,6],[15,7,17106],[15,8,23],[15,9,55731],[15,10,2],[15,11,51833],[15,12,34012],[15,13,4],[15,14,40069],[15,15,1],[15,16,33366],[15,17,13],[15,18,4454],[15,19,22018],[16,0,67034],[16,1,2],[16,2,4],[16,3,7],[16,4,17],[16,5,2],[16,6,8],[16,7,79091],[16,8,12954],[16,9,28],[16,10,48191],[16,11,21179],[16,12,18942],[16,13,4],[16,14,12364],[16,15,36519],[16,16,0],[16,17,7],[16,18,0],[16,19,2],[17,0,53967],[17,1,4],[17,2,6334],[17,3,7407],[17,4,18294],[17,5,20181],[17,6,4],[17,7,82826],[17,8,23],[17,9,57882],[17,10,76383],[17,11,10],[17,12,3],[17,13,2],[17,14,8],[17,15,16],[17,16,7],[17,17,0],[17,18,5],[17,19,2],[18,0,1],[18,1,12637],[18,2,0],[18,3,0],[18,4,23],[18,5,3777],[18,6,0],[18,7,0],[18,8,2],[18,9,5659],[18,10,4],[18,11,0],[18,12,1],[18,13,7],[18,14,13144],[18,15,3433],[18,16,0],[18,17,2],[18,18,0],[18,19,10],[19,0,0],[19,1,52446],[19,2,5158],[19,3,0],[19,4,10667],[19,5,2],[19,6,27194],[19,7,4],[19,8,1],[19,9,14],[19,10,0],[19,11,6563],[19,12,4],[19,13,4],[19,14,2],[19,15,7262],[19,16,2],[19,17,4],[19,18,1],[19,19,0]];

    if (heatmap) {
        visualize(aminoacids, heatmap)
    } else {


        //Build an array of promises (SPARQL queries) 20x20 = 400 queries!
        for (var i = 0; i < aminoacids.length; i++) {
            matrix[i] = [];
            var original = aminoacids[i];
            for (var j = 0; j < aminoacids.length; j++) {
                matrix[i][j] = 0;
                var variant = aminoacids[j];
                query = sparqlQuery.replace("AAO", original).replace("AAV", variant);

                console.log(query)
                promises.push(nx.executeSparql(query));

            }
        }
        
        //Wait for all executions of the sparql queries
        Promise.all(promises).then(function (values) {

            var heatmap = [];
            var cnt = 0;
            for (var i = 0; i < aminoacids.length; i++) {
                for (var j = 0; j < aminoacids.length; j++) {
                    result = values[cnt++];
                    if (result.results.bindings && result.results.bindings.length > 0) {
                        matrix[i][j] = parseInt(result.results.bindings[0].cnt.value);
                    }
                    heatmap.push([i, j, matrix[i][j]])

                }
            }

            console.log(JSON.stringify(heatmap))
            visualize(aminoacids, heatmap)

        });

    }

</script>