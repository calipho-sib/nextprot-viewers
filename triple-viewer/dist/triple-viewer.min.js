/*! triple-viewer 2015-08-28 */
function TripleViewer(a){function b(a){if($("#nx-isoformChoice").length>0){var b={isoforms:function(){var b={visible:[],more:[]};return a.sort(function(a,b){return parseInt(a.uniqueName.split("-")[1])-parseInt(b.uniqueName.split("-")[1])}).forEach(function(a,c){3>=c?b.visible.push(a):b.more.push(a)}),b}()};t=b.isoforms.visible[0].uniqueName;var c=HBtemplates["templates/isoformChoice.tmpl"],d=c(b);$("#nx-isoformChoice").append(d),y.isoform(),$(document).ready(function(){$(".isoformNames").tooltip({trigger:"hover"})}),$("#nx-isoformChoice li:first-child").addClass("active")}}function c(){$(function(){$("#isoformMap").click(function(){$("#isoformDisplayed #isoContainer").toggle("slow")}),$("#isoformDisplayed #isoContainer").hide()})}function d(a,b,c){function d(a){var b=0;for(q in a)for(var c in a[q].positions)a[q].positions[c].second>b&&(b=a[q].positions[c].second);return b}function e(a){var b=1e8;for(q in a)for(var c in a[q].positions)a[q].positions[c].first<b&&(b=a[q].positions[c].first);return b}function f(a){console.log("YOU ARE IN THE MATRIX");var b=p.append("g").attr("class","rectangle").attr("transform","translate(0,"+i+")");b.append("path").attr("d",n([{x:h,y:0},{x:g,y:0}])).attr("class",function(){return"line"}).style("z-index","0").style("stroke","#C2DEC8").style("stroke-width","1px");var d=b.selectAll("."+a.isoformAc+"Group").data(a.positions).enter().append("g").attr("class",a.isoformAc+"Group").attr("transform",function(a){return"translate("+m(a.first)+",0)"});d.append("rect").attr("class",function(){return a.isoformAc===c?"element "+a.isoformAc+"Rect isoSelected":"element "+a.isoformAc+"Rect"}).attr("width",function(a){return m(a.second)-m(a.first)}).attr("height",12).style("fill","#C2DEC8").style("z-index","13").style("cursor","pointer").on("click",function(){y.reload(a.isoformAc);var b=$("#nx-isoformChoice a[href=#"+a.isoformAc+"]").tab("show");b.parent().parent().is("#moreIsoforms")&&$("#extendIsoformChoice").text(a.isoformAc)}),d.append("text").attr("class","element "+a.isoformAc+"Text").attr("y",6).attr("dy","0.35em").style("font-size","10px").text(function(b){return a.isoformMainName}).style("fill","black").style("z-index","15").style("visibility",function(b){return a.isoformMainName&&m(b.second)-m(b.first)>8*a.isoformMainName.length?"visible":"hidden"}),i+=20}$(b+" #isoContainer").html(""),!$("#isoContainer").length>0&&$(b).append('<div id="isoContainer"></div>');var g=d(a),h=e(a),i=20,j={top:10,right:50,bottom:0,left:50},k=w-j.left-j.right-17,l=200-j.top-j.bottom,m=d3.scale.linear().domain([h,g]).range([0,k]),n=d3.svg.line().interpolate("linear").x(function(a){return m(a.x)}).y(function(a){return a.y+6}),o=d3.select(b+" #isoContainer").append("svg").attr("width",k+j.left+j.right).attr("height",l+j.top+j.bottom).style("z-index","2"),p=o.append("g").attr("transform","translate("+j.left+","+j.top+")");for(var q in a)f(a[q],q);o.attr("height",i+10+"px")}function e(a,b){a.forEach(function(a){a.uniqueName===b&&(p=a.sequence,n=new FeatureViewer(p,".chart",{showAxis:!0,showSequence:!0,brushActive:!0,verticalLine:!1,toolbar:!0}),o=new Sequence(p,b),o.render("#seqViewer",{showLineNumbers:!0,wrapAminoAcids:!0,charsPerLine:50,search:!0,toolbar:!0}))})}function f(a){console.log("REGENESIS OF THE DATAAAAA");for(var b=0;b<u.length;b++)if(0!==Object.keys(u[b]).length&&u[b].hasOwnProperty(a)&&x[u[b][a].filter.split(" ").join("_").toLowerCase()]===!0){var c=jQuery.extend({},u[b][a]);n.addFeature(c)}}function g(){$(".chart").append('<div class="svgHeader" class="row" style="margin:0px 20px"></div>');s={filters:{}};for(var a=0;a<u.length;a++)if(0!==Object.keys(u[a]).length){var b=u[a][Object.keys(u[a])[0]].filter;if("none"!==b&&!s.filters[b.split(" ").join("_").toLowerCase()]){var c=b.split(" ").join("_").toLowerCase();s.filters[c]=b,x[c]=!0}}var d=HBtemplates["templates/filter.tmpl"],e=d(s);$(".svgHeader").html(e)}function h(a){function b(){$(".evidenceNumber").click(function(){$(this).parent().parent().next().toggle()})}if($("#featuresTable").length>0){var c=0,d=[];v.forEach(function(b){b.hasOwnProperty(a)&&d.push(b[a])});for(feat in v)v[feat].hasOwnProperty(a)&&(c+=v[feat][a].length);Handlebars.registerHelper("position",function(a,b){return 1===a?this.start:"Disulfide bond"===this.category?this.start+'<span style="line-height: 0.8; vertical-align:top">&#x256d;&#x256e;</span>'+this.end:this.start+" - "+this.end}),Handlebars.registerHelper("className",function(a,b){return a.replace(" ","")+" "+this.group.split(" ").join("_").toLowerCase()}),Handlebars.registerHelper("math",function(a,b,c){return a=parseFloat(a),b=parseFloat(b),a+b}),Handlebars.registerHelper("linkTo",function(a,b,c){return'<a href="'+b+'">'+a+"</a>"});var e={features:d,featuresLength:c},f=HBtemplates["templates/featureTable2.tmpl"],g=f(e);$("#featuresTable").html(g),b()}}function i(a){var b=[],c=[];for(var d in a)a[d].positions.forEach(function(a){b.push(a.first,a.second)});b=b.filter(function(a,b,c){return b==c.indexOf(a)}),b.sort(function(a,b){return a-b});for(var e=0;e<b.length-1;e++){var f=!1;for(var g in q){for(var h in a[g].positions){if(a[g].positions[h].first>b[e+1])break;if(a[g].positions[h].first<=b[e]&&a[g].positions[h].second>=b[e+1]){f=!0;break}}if(f===!0)break}f===!1&&c.push({x:b[e],length:b[e+1]-b[e]})}for(var e=c.length-1;e>=0;e--)for(var g in a)for(var h=a[g].positions.length-1;h>=0;h--){if(a[g].positions[h].first<c[e].x){0===e&&a[g].positions[h+1].first===a[g].positions[h].second&&(a[g].positions[h].second=a[g].positions[h+1].second,a[g].positions.splice(h+1,1));break}a[g].positions[h].first-=c[e].length,a[g].positions[h].second-=c[e].length,h!=a[g].positions.length-1&&a[g].positions[h+1].first===a[g].positions[h].second&&(a[g].positions[h].second=a[g].positions[h+1].second,a[g].positions.splice(h+1,1))}return a}function j(){$(".featPosition").click(function(){$(".tableHighlight").removeClass("tableHighlight"),$(this).parent().parent().addClass("tableHighlight");var a=$(this).parent().parent().attr("id"),b=a.split("_").slice(1).map(Number);1===b.length&&b.push(b[0]);var c="#f"+a;b[0]-=1,o.selection(b[0],b[1],"#C50063"),n.selection(c);var d=$("#stringSelected").position().top-200,e=$("#scroller").scrollTop(),f=d+e;$("#scroller").animate({scrollTop:f},1e3)})}function k(){$(".element").click(function(a){var b=this.id.slice(1),c=b.split("_").slice(1).map(Number);c[0]-=1,o.selection(c[0],c[1],"#C50063"),$(".tableHighlight").removeClass("tableHighlight"),$("#"+b).addClass("tableHighlight");var d=$("#"+b).position().top-70,e=$("#featTableScroller").scrollTop(),f=d+e;$("#featTableScroller").animate({scrollTop:f},1e3);var g=$("#stringSelected").position().top-200,h=$("#scroller").scrollTop(),i=g+h;$("#scroller").animate({scrollTop:i},1e3)})}function l(){$("#filtering input:checkbox").on("change",function(){if($(this)[0]===$("#allFilters")[0]){var a=$(this).prop("checked");if($(this).parents("#filtering").first().find("input[type=checkbox]").prop("checked",a),a===!1)for(var b in x)x[b]=!1;else for(var b in x)x[b]=!0;x.none=!0}m(),y.reloadSVG(t)})}function m(){for(var a in s.filters)$("#"+a).prop("checked")?($("."+a+".general-info").show(),x[a]=!0):($("."+a).hide(),x[a]=!1)}var n,o,p,q,r,s,t=a+"-1",u=[],v=[],w=0,x={none:!0},y={isoform:function(){$(".isoformNames").click(function(){t=$(this).text(),y.reload(t)}),$("#moreIsoforms a").click(function(){var a=$(this).text();$("#extendIsoformChoice").text(a)})},init:function(a,m){q=a[0],b(a[0]),w=$("#visuContainer").width();for(var n=1;n<a.length-1;n++){var o=NXUtils.convertMappingsToIsoformMap(a[n],m[n].name,m[n].filter);v.push(o),a[n]instanceof Array||console.log("BANANA !");var p=NXViewerUtils.convertNXAnnotations(o,m[n]);u.push(p)}r=i(a[a.length-1]),d(r,"#isoformDisplayed",t),c(),g(),e(q,t),f(t),h(t),j(),k(),l()},reload:function(a){$(".chart svg").remove(),e(q,a),f(a),h(a),m(),j(),k(),d(r,"#isoformDisplayed",a),$(".zoomUnit").length&&$(".zoomUnit").text("1"),d3.selectAll("div.selectedRect").remove()},reloadSVG:function(a){$(".chart svg").remove(),e(q,a),f(a),$(".zoomUnit").length&&$(".zoomUnit").text("1"),d3.selectAll("div.selectedRect").remove(),k()}};return{init:y.init}}